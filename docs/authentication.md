# Authenticating the websocket connection

To establish a websocket connection, you need a valid JWT token generated by the Bose servers.

This is the content of the JWT that worked for me

```json
{
  "aud": [
    "https://prod.castle.bose.io",
    "https://prod.castle.bose.io/client_apikey/<50 hex characters, not sure if unique or hardcoded>"
  ],
  "auth_time": 1670000000,
  "exp": 1670000000,
  "grant_type": "id_token",
  "https://bose.io/bose-person-id": "<user uuid>",
  "https://bose.io/sub": {
    "bose": "<user uuid>",
    "gig": "<32 hex characters>"
  },
  "iat": 1670000000,
  "iss": "https://prod.castle.bose.com/user_token_ms",
  "jti": "<uuid>",
  "nbf": 1670000000,
  "realm": "/users",
  "scope": "openid",
  "sub": "<user uuid>",
  "tokenName": "refresh_token",
  "token_type": "refresh"
}
```

### "Gigya" auth

First login step is done with https://accounts.us1.gigya.com/accounts.login

Information about that is available here: https://help.sap.com/docs/SAP_CUSTOMER_DATA_CLOUD/8b8d6fffe113457094a17701f63e3d6a/683844d3c4b54104b2201efffdf558e3.html

It then calls https://accounts.us1.gigya.com/accounts.getJWT to get a JWT to use for the next step

We then transfer over to the bose api's and get the actual JWT we can use

```
POST /id-jwt-core/token HTTP/1.1
Host: id.api.bose.io
Accept: */*
X-Software-Version: 8.0.6-27689
Accept-Language: en-US;q=1.0, nl-US;q=0.9
X-Api-Key: <api key, not sure if hardcoded>
X-Api-Version: 1
X-ApiKey: <api key, not sure if hardcoded (same as before)>
Content-Length: 1051
User-Agent: MadridApp/8.0.6 (com.bose.bosemusic; build:27689; iOS 17.1.0) Alamofire/5.6.2
Connection: keep-alive
Accept-Encoding: br;q=1.0, gzip;q=0.9, deflate;q=0.8
Content-Type: application/json; charset=utf-8
```

```json
{
  "id_token": "<JWT from https://accounts.us1.gigya.com/accounts.getJWT",
  "client_id": "<50 char hex",
  "uid_signature": "<28 char base64>",
  "signature_timestamp": "1670000000",
  "grant_type": "id_token",
  "uid": "<32 hex char userid>",
  "scope": "openid"
}
```

This responds with:

```json
{
  "access_token": "<jwt>",
  "bosePersonID": "<uuid>",
  "expires_in": 14400,
  "refresh_token": "<jwt>",
  "token_type": "Bearer"
}
```

The `access_token` expires in 4 hours, the `refresh_token` expires in 1 year.
The device seems to directly accept the `refresh_token` as a valid JWT token. So no need to get new access tokens if we are not scared of someone snooping on your network.

### Note: Api endpoints

The bose app seems to request a url in the format `https://services.api.bose.io/discovery/discover/user/<32 hex chars>`

This is the response I got from that url

```json
{
  "services": {
    "auth-proxy": {
      "url": "https://content.api.bose.io/core02/svc-auth-proxy/prod/auth-proxy"
    },
    "bmx-adapter-amazon": {
      "url": "https://content.api.bose.io/core02/svc-bmx-adapter-amazon/prod/live-adapter"
    },
    "bmx-adapter-deezer": {
      "url": "https://content.api.bose.io/core02/svc-bmx-adapter-deezer/prod/live-adapter"
    },
    "bmx-adapter-iheart": {
      "url": "https://content.api.bose.io/core02/svc-bmx-adapter-iheart/prod/live-adapter"
    },
    "bmx-adapter-pandora": {
      "url": "https://content.api.bose.io/core02/svc-bmx-adapter-pandora/prod/live-adapter"
    },
    "bmx-adapter-stream": {
      "url": "https://content.api.bose.io/core02/svc-bmx-adapter-stream/prod/live-adapter"
    },
    "bmx-adapter-siriusxm-everest": {
      "url": "https://content.api.bose.io/core02/svc-bmx-adapter-siriusxm-everest/prod/live-adapter"
    },
    "bmx-adapter-spotify": {
      "url": "https://content.api.bose.io/core02/svc-bmx-adapter-spotify/prod/live-adapter"
    },
    "bmx-adapter-trio": {
      "url": "https://content.api.bose.io/core02/svc-bmx-adapter-trio/prod/live-adapter"
    },
    "bmx-adapter-tunein-eco2": {
      "url": "https://content.api.bose.io/core02/svc-bmx-adapter-tunein-eco2/prod/live-adapter"
    },
    "bmx-msp-account-linking-service": {
      "url": "https://content.api.bose.io/accounts"
    },
    "eco2-bmx-registry": {
      "url": "https://content.api.bose.io/core02/svc-eco2-bmx-registry/prod/live-registry"
    },
    "voice-3pda-tokens-core": {
      "url": "https://voice.api.bose.io/prod/avs/tokens"
    },
    "voice-3pda-mutual-auth-core": {
      "url": "https://voice.api.bose.io/prod/avs/mutualAuth"
    },
    "voice-3pda-discovery-core": {
      "url": "https://voice.api.bose.io/prod/avs/discovery"
    },
    "voice-3pda-directive-core": {
      "url": "https://voice.api.bose.io/prod/avs/directive"
    },
    "voice-configuration-core": {
      "url": "https://voice.api.bose.io/prod/voiceConfiguration"
    },
    "iot-product-activation-core": {
      "url": "https://iot.api.bose.io/iot-product-activation-core"
    },
    "iot-product-state-core": {
      "url": "https://iot.api.bose.io/iot-product-state-core"
    },
    "iot-product-info-core": {
      "url": "https://iot.api.bose.io/iot-product-info-core"
    },
    "iot-product-event-core": {
      "url": "https://iot.api.bose.io/iot-product-event-core"
    },
    "logan-auth": {
      "url": "https://partners.api.bose.io/auth"
    },
    "logan-mgmt-host": {
      "url": "https://partners.api.bose.io/manage"
    },
    "passport": {
      "url": "https://users.api.bose.io/passport-core"
    },
    "id-irk-core": {
      "url": "https://id.api.bose.io/id-irk-core"
    },
    "id-jwt-core": {
      "url": "https://id.api.bose.io/id-jwt-core"
    },
    "id-mfg-info-core": {
      "url": "https://id.api.bose.io/id-mfg-info-core"
    },
    "id-product-access-core": {
      "url": "https://id.api.bose.io/id-product-access-core"
    },
    "id-product-feature-unlock-core": {
      "url": "https://id.api.bose.io/id-product-feature-unlock-core"
    },
    "id-product-jwt-core": {
      "url": "https://id.api.bose.io/id-product-jwt-core"
    },
    "id-user-accounts-core": {
      "url": "https://id.api.bose.io/id-user-accounts-core"
    },
    "svc-ota-update": {
      "url": "https://iot.api.bose.io/svc-ota-update"
    },
    "video-channel-resolver": {
      "url": "https://voice.api.bose.io/prod/videoChannelResolver"
    },
    "beaker": {
      "url": "https://beta.api.bose.io/core02/svc-beaker-info/prod/beaker-info"
    },
    "bunsen2": {
      "url": "https://beta.api.bose.io/experiences"
    },
    "v4v-config-core": {
      "url": "https://voice.api.bose.io/prod/v4vConfig"
    },
    "voice-comms-dc-core": {
      "url": "https://voice.api.bose.io/prod/commsDataCollector"
    },
    "gigya-oidc-geneva": {
      "url": "https://id.api.bose.io/prod/geneva-oidc-proxy"
    },
    "diagnosticfilesna": {
      "url": "https://na.data.api.bose.io/production/diagnosticna"
    },
    "data-collector": {
      "url": "https://data.api.bose.io/production/data-collector",
      "type": "static-route"
    },
    "diagnostic-files": {
      "url": "https://data.api.bose.io/production/diagnostic",
      "type": "static-route"
    },
    "svc-naota-update-service": {
      "url": "https://updates-framingham-prod.smartproducts.bose.io",
      "type": "static-route"
    }
  },
  "ttl": 86400,
  "environment": "production"
}
```
